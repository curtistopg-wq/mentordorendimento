---
phase: 01-foundation-database-security
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/supabase/middleware.ts
  - middleware.ts
autonomous: true

must_haves:
  truths:
    - "Middleware refreshes Supabase session on every request"
    - "Internationalization (next-intl) continues to work"
    - "Static assets are excluded from middleware"
  artifacts:
    - path: "src/lib/supabase/middleware.ts"
      provides: "updateSession function for token refresh"
      exports: ["updateSession"]
    - path: "middleware.ts"
      provides: "Combined middleware (i18n + Supabase session)"
      exports: ["middleware", "config"]
  key_links:
    - from: "middleware.ts"
      to: "src/lib/supabase/middleware.ts"
      via: "import updateSession"
      pattern: "updateSession"
    - from: "middleware.ts"
      to: "next-intl/middleware"
      via: "chained middleware execution"
      pattern: "createMiddleware.*intlMiddleware"
    - from: "src/lib/supabase/middleware.ts"
      to: "supabase.auth.getUser()"
      via: "token refresh call"
      pattern: "auth\\.getUser\\(\\)"
---

<objective>
Create Supabase middleware utility and integrate it with existing next-intl middleware.

Purpose: Ensure auth tokens are refreshed on every request, preventing session expiration during active use. This is REQUIRED for Supabase auth to work properly with Server Components.

Output:
- Supabase middleware utility at src/lib/supabase/middleware.ts
- Updated root middleware.ts that chains Supabase + i18n middleware
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-database-security/01-RESEARCH.md
@middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Supabase middleware utility</name>
  <files>src/lib/supabase/middleware.ts</files>
  <action>
Create `src/lib/supabase/middleware.ts` with:
```typescript
import { createServerClient } from '@supabase/ssr'
import { NextResponse, type NextRequest } from 'next/server'

export async function updateSession(request: NextRequest) {
  let supabaseResponse = NextResponse.next({
    request,
  })

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll()
        },
        setAll(cookiesToSet) {
          cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value))
          supabaseResponse = NextResponse.next({
            request,
          })
          cookiesToSet.forEach(({ name, value, options }) =>
            supabaseResponse.cookies.set(name, value, options)
          )
        },
      },
    }
  )

  // IMPORTANT: Do NOT remove this line
  // Refreshes the auth token if expired
  // Use getUser() not getSession() - getUser() validates the JWT
  await supabase.auth.getUser()

  return supabaseResponse
}
```

CRITICAL: Use `getUser()` not `getSession()`. getSession() does NOT validate the JWT signature and is a security risk on the server.
  </action>
  <verify>
Run `npx tsc --noEmit` - should complete without TypeScript errors.
File exists and exports updateSession function.
Grep for "getUser()" in the file - it must be present.
  </verify>
  <done>
src/lib/supabase/middleware.ts exists and exports updateSession function.
Uses getUser() (not getSession()) for token validation.
Handles cookies with getAll/setAll pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update root middleware to chain Supabase + i18n</name>
  <files>middleware.ts</files>
  <action>
The existing middleware.ts only handles i18n. Update it to chain both Supabase session refresh AND i18n handling.

Replace the contents of `middleware.ts` with:
```typescript
import { type NextRequest } from 'next/server'
import createIntlMiddleware from 'next-intl/middleware'
import { updateSession } from '@/lib/supabase/middleware'
import { locales, defaultLocale } from './src/i18n'

const intlMiddleware = createIntlMiddleware({
  locales,
  defaultLocale,
  localePrefix: 'always'
})

export async function middleware(request: NextRequest) {
  // First, refresh Supabase session (sets cookies on response)
  const supabaseResponse = await updateSession(request)

  // Then run i18n middleware
  const intlResponse = intlMiddleware(request)

  // Merge cookies from Supabase response into i18n response
  supabaseResponse.cookies.getAll().forEach(cookie => {
    intlResponse.cookies.set(cookie.name, cookie.value)
  })

  return intlResponse
}

export const config = {
  matcher: [
    // Match all paths except static files and api routes that don't need i18n/auth
    '/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',
  ],
}
```

This middleware:
1. Refreshes Supabase auth tokens first (prevents session expiration)
2. Handles internationalization routing
3. Merges cookies so both systems work together
4. Excludes static files from middleware processing for performance

The matcher is broader than before to ensure Supabase session refresh runs on all dynamic routes.
  </action>
  <verify>
Run `npx tsc --noEmit` - should complete without TypeScript errors.
Run `npm run dev` - server should start without middleware errors.
Verify in browser that locale routing still works (visiting / redirects to /en or /pt-BR).
  </verify>
  <done>
middleware.ts imports updateSession from @/lib/supabase/middleware.
middleware.ts chains Supabase session refresh with i18n middleware.
Cookies from both middlewares are merged properly.
Static assets are excluded from middleware.
Dev server starts without errors.
Locale routing continues to work.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npx tsc --noEmit` completes without errors
2. `npm run dev` starts successfully
3. Visiting http://localhost:3000 redirects to locale prefix (i18n working)
4. No errors in browser console related to Supabase or middleware
</verification>

<success_criteria>
1. Supabase middleware utility exists and exports updateSession
2. Root middleware chains Supabase + i18n without errors
3. Internationalization routing continues to work
4. Dev server starts and runs without middleware errors
5. TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-database-security/01-02-SUMMARY.md`
</output>
