---
phase: 01-foundation-database-security
plan: 04
type: execute
wave: 2
depends_on: ["01-01", "01-03"]
files_modified:
  - src/types/database.types.ts
autonomous: false

must_haves:
  truths:
    - "TypeScript types are generated from database schema"
    - "TypeScript autocomplete works for all tables"
    - "Types include all 7 tables (profiles, courses, modules, lessons, enrollments, progress, materials)"
  artifacts:
    - path: "src/types/database.types.ts"
      provides: "Generated TypeScript types for all database tables"
      contains: "Database"
  key_links:
    - from: "src/types/database.types.ts"
      to: "supabase/migrations/*"
      via: "generated from schema"
      pattern: "profiles.*courses.*modules.*lessons.*enrollments.*progress.*materials"
---

<objective>
Generate TypeScript types from Supabase schema and verify RLS in Supabase Dashboard.

Purpose: Enable type-safe database queries with full autocomplete. This prevents runtime errors from typos and schema mismatches. Also verify Security Advisor has no warnings.

Output:
- Generated TypeScript types at src/types/database.types.ts
- Verified RLS policies in Supabase Security Advisor (no warnings)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-database-security/01-RESEARCH.md
@.planning/phases/01-foundation-database-security/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Link Supabase project and push migrations</name>
  <files>supabase/.temp/project-ref</files>
  <action>
First, ensure environment variables are set with REAL values (not placeholders).
Check `.env.local` has actual values from Supabase dashboard.

Link to the remote Supabase project:
```bash
npx supabase link --project-ref YOUR_PROJECT_REF
```

The project-ref can be found in Supabase Dashboard URL: `supabase.com/dashboard/project/YOUR_PROJECT_REF`

Then push the migrations to the remote database:
```bash
npx supabase db push
```

This applies the migration to your actual Supabase database.

IMPORTANT: This requires:
1. Supabase project already created at supabase.com
2. .env.local has real NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY
3. You may be prompted to login: `npx supabase login`
  </action>
  <verify>
Run `npx supabase db push` - should show migrations applied or "Database is up to date".
No errors about missing tables or failed migrations.
  </verify>
  <done>
Supabase project linked successfully.
Migrations pushed to remote database.
All 7 tables created in Supabase.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate TypeScript types</name>
  <files>src/types/database.types.ts</files>
  <action>
Create the types directory if it doesn't exist:
```bash
mkdir -p src/types
```

Generate TypeScript types from the linked Supabase project:
```bash
npx supabase gen types typescript --linked > src/types/database.types.ts
```

This generates types directly from your remote Supabase database schema.

After generation, verify the file contains all expected tables:
- profiles
- courses
- modules
- lessons
- enrollments
- progress
- materials

Also add a convenience export for typed client usage at the end of the file (manually append):
```typescript
// Convenience type exports
export type Profile = Database['public']['Tables']['profiles']['Row']
export type Course = Database['public']['Tables']['courses']['Row']
export type Module = Database['public']['Tables']['modules']['Row']
export type Lesson = Database['public']['Tables']['lessons']['Row']
export type Enrollment = Database['public']['Tables']['enrollments']['Row']
export type Progress = Database['public']['Tables']['progress']['Row']
export type Material = Database['public']['Tables']['materials']['Row']
```
  </action>
  <verify>
File exists at src/types/database.types.ts.
Grep for each table name in the file.
Run `npx tsc --noEmit` - should compile without errors.
  </verify>
  <done>
TypeScript types generated for all 7 tables.
Convenience type exports added.
TypeScript compiles without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Database schema deployed to Supabase with RLS policies on all tables.
TypeScript types generated for type-safe queries.
  </what-built>
  <how-to-verify>
1. Go to Supabase Dashboard -> Your Project
2. Click "Database" in left sidebar
3. Click "Tables" - verify all 7 tables exist (profiles, courses, modules, lessons, enrollments, progress, materials)
4. For each table, click it and go to "Policies" tab - verify policies exist
5. Go to "Database" -> "Security Advisor" (at bottom of sidebar)
6. Verify NO warnings appear (all tables should have RLS enabled)

Expected:
- All 7 tables visible in Tables view
- Each table has RLS policies when you click on it
- Security Advisor shows all green (no warnings)

If Security Advisor shows warnings:
- "RLS disabled" for any table = BLOCKER, must fix
- Other warnings = note them but can proceed
  </how-to-verify>
  <resume-signal>Type "approved" if Security Advisor shows no RLS warnings, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npx supabase db push` reports success or "up to date"
2. src/types/database.types.ts exists and contains all 7 tables
3. `npx tsc --noEmit` completes without errors
4. Supabase Security Advisor shows no RLS warnings
</verification>

<success_criteria>
1. Migrations successfully applied to Supabase (all tables created)
2. TypeScript types generated with all 7 tables
3. TypeScript autocomplete works for database tables
4. Security Advisor shows no RLS warnings (DATA-01 verified)
5. Types compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-database-security/01-04-SUMMARY.md`
</output>
